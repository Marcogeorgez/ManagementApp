@using MudBlazor
@using System.Text
@using System.Text.RegularExpressions
@inject ISnackbar Snackbar
@inject CloudflareR2Service CloudflareService

<MudDialog>
    <DialogContent>
        @if(isViewMode){
            <MudGrid Spacing="1">
                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="0">
                        <MudGrid Spacing="4">
                            <MudItem xs="12" sm="12" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Project Name</MudText>
                                <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(project.ProjectName) ? "-" : project.ProjectName)</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="12" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Footage Links</MudText>
                                @if (!string.IsNullOrEmpty(project.FootageLink))
                                {
                                    @foreach (var word in project.FootageLink.Split(' '))
                                    {
                                        if (StringHelper.IsLink(word))
                                        {
                                            <MudLink Href="@word" Target="_blank" Typo="Typo.body1">@word</MudLink>
                                        }
                                        else
                                        {
                                            <span> @word </span>
                                        }
                                        <span>&nbsp;</span>
                                    }
                                }
                                else
                                {
                                    <MudText Typo="Typo.body1">-</MudText>
                                }
                            </MudItem>

                            <MudItem xs="12" sm="6" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Resolution</MudText>
                                <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(project.ProjectSpecifications?.Resolution) ? "-" : project.ProjectSpecifications.Resolution)</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Footage Size</MudText>
                                <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(project.ProjectSpecifications?.Size) ? "-" : project.ProjectSpecifications.Size)</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Number of Cameras</MudText>
                                <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(project.ProjectSpecifications?.CameraNumber) ? "-" : project.ProjectSpecifications.CameraNumber)</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Color Profile</MudText>
                                <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(project.ProjectSpecifications?.ColorProfile) ? "-" : project.ProjectSpecifications.ColorProfile)</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6" Style="min-height: 60px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default">Audio Details</MudText>
                                <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(project.ProjectSpecifications?.AudioDetails) ? "-" : project.ProjectSpecifications.AudioDetails)</MudText>
                            </MudItem>

                            <MudItem xs="12" Style="min-height: 100px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default" Class="mb-2">Deliverables</MudText>
                                <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                                    @if (!string.IsNullOrEmpty(project.Deliverables))
                                    {
                                        var processedDeliverablesHtml = StringHelper.ProcessDeliverables(project.Deliverables);
                                        <MudHtmlViewer Html="@processedDeliverablesHtml" />
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1">-</MudText>
                                    }
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" Style="min-height: 100px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default" Class="mb-2">Brief Of The Day and Technical Issues Notes</MudText>
                                <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                                    @if (!string.IsNullOrEmpty(project.Description))
                                    {
                                        var processedBriefDayHtml = StringHelper.ProcessDeliverables(project.Description);
                                        <MudHtmlViewer Html="@processedBriefDayHtml" />
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1">-</MudText>
                                    }
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" Style="min-height: 100px">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default" Class="mb-2">Music Preferences</MudText>
                                <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                                    @if (!string.IsNullOrEmpty(project.MusicPreference))
                                    {
                                        var processedMusicPreferenceHtml = StringHelper.ProcessDeliverables(project.MusicPreference);
                                        <MudHtmlViewer Html="@processedMusicPreferenceHtml" />
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1">-</MudText>
                                    }
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12">
                                <MudText Typo="Typo.subtitle2" Color="Color.Default" Class="mb-2">Revisions</MudText>
                                @if (project.Revisions != null && project.Revisions.Any())
                                {
                                    foreach (var revision in project.Revisions.OrderBy(r => r.RevisionId))
                                    {
                                        <MudExpansionPanels MultiExpansion=false Elevation="0">
                                            <MudExpansionPanel Class="mt-2" Expanded=@(revision == project.Revisions.OrderBy(r => r.RevisionDate).Last())>
                                                <TitleContent>
                                                    <div class="d-flex align-center">
                                                        @if (revision.isCompleted)
                                                        {

                                                            <span style="font-weight:bold">
                                                                <MudChip T="int" Variant="Variant.Outlined"
                                                                Color="Color.Success"
                                                                Size="Size.Medium">
                                                                    Completed
                                                                </MudChip>
                                                            </span>
                                                        }
                                                        <span class="ml-2">Revision Date: @revision.RevisionDate.ToString("MM-dd-yyyy")</span>
                                                    </div>
                                                </TitleContent>
                                                <ChildContent>
                                                    <div class="allow-border">
                                                        <MudHtmlViewer  Html="@revision.Content" />
                                                    </div>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        </MudExpansionPanels>
                                    }
                                }
                                else
                                {
                                    <MudText Typo="Typo.body1">-</MudText>
                                }
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>

        }
        else{
            <MudGrid Spacing="1">
                <MudItem xs="12" sm="12">
                    <MudTextField Class="mb-5" Label="Project Name" ReadOnly="!isAdmin"
                    Variant="Variant.Outlined" Disabled=!isAdmin @bind-Value="project.ProjectName"></MudTextField>
                </MudItem>
                <MudItem xs="12" sm="12">

                    <MudTextField T="string"
                    Label="Footage Link" Placeholder="Add link of your footage" AutoGrow="true"
                    Variant="Variant.Outlined" @bind-Value="project.FootageLink" />
                </MudItem>
                <MudGrid Class="equal-height">
                    <MudItem xs="12" sm="6">
                        <MudTextField T="string" AutoGrow="true"
                        Label="Add Details of Resolution" Placeholder="Add Details of Footage Resolution"
                        Variant="Variant.Outlined" @bind-Value="project.ProjectSpecifications.Resolution"/>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField T="string" AutoGrow="true"
                        Label="Add Details of Footage size"
                        Placeholder="Add Details of Footage size"
                        Variant="Variant.Outlined"
                        @bind-Value="project.ProjectSpecifications.Size"
                        />
                    </MudItem>
                </MudGrid>
                <MudGrid Class="equal-height">
                    <MudItem xs="12" sm="6">
                        <MudTextField T="string" AutoGrow="true"
                        Label="Add Details of Footage Number of Cameras"
                        Placeholder="Add Details of Number of cameras"
                        Variant="Variant.Outlined"
                        @bind-Value="project.ProjectSpecifications.CameraNumber"
                        />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField T="string" AutoGrow="true"
                        Label="Add Details of Color profile"
                        Placeholder="Add Details of Color profile for each camera"
                        Variant="Variant.Outlined"
                        @bind-Value="project.ProjectSpecifications.ColorProfile"
                        />
                    </MudItem>
                </MudGrid>

                <MudGrid Class="equal-height">
                    <MudItem xs="12" sm="6">
                        <MudTextField T="string" AutoGrow="true"
                        Label="Add Audio Details"
                        Placeholder="Add Details about Audio recorders"
                        Variant="Variant.Outlined"
                        @bind-Value="project.ProjectSpecifications.AudioDetails" />
                    </MudItem>
                </MudGrid>

                <MudItem xs="12" sm="12" Class="mt-5  flex-column">
                    <MudHtmlEditor Outlined="true" Label="Deliverables" Text="Deliverables" Html="@project.Deliverables"  OnFileUpload="@HandleFileUpload"
                    HtmlChanged="OnDeliverableTextChanged" Resizable="true" style="min-height:100px;"
                    Placeholder="Please write down what the deliverables for this project will be">
                    </MudHtmlEditor>
                </MudItem>

                <MudItem xs="12" sm="12" Class="mt-5  flex-column">
                    <MudHtmlEditor Html="@project.Description" HtmlChanged="OnNoteTextChanged" style="min-height:200px;" OnFileUpload="@HandleFileUpload"
                    Label="Brief Of The Day and Technical Issues Notes"
                    Placeholder="Example: This wedding was shot on Oahu, at Ko'olau Ballrooms.
This is the Bride's second marriage, and they're a little older than the usual bride and grooms we have.
This is a Hawaiian Wedding, so segments will have prayers in Hawaiian language, but the rest is in English. The Ceremony is in English, the speeches are in English.
The Bride was married like I said before, so this wedding was quite special because she didn't think she'd ever get married again until she met Keola.">
                    </MudHtmlEditor>
                </MudItem>

                <MudItem xs="12" sm="12" Class="mt-5  flex-column">
                    <MudHtmlEditor Outlined="true" Label="Music Preferences" OnFileUpload="@HandleFileUpload"
                    Text="Music Preferences"
                    Html="@project.MusicPreference"
                    HtmlChanged="OnMusicTextChanged"
                    Resizable="true"
                    style="min-height:50px;"
                    Placeholder="Place link to music here and any comments">
                    </MudHtmlEditor>
                </MudItem>

                <MudItem xs="12" sm="12">
                    <MudText Typo=Typo.body1  Class="mt-5 " >Revisions:

                        @if (project.Revisions != null)
                        {                           
                            <MudExpansionPanels MultiExpansion=false Elevation="0">
                                @foreach (var revision in project.Revisions.OrderBy(r => r.RevisionDate))
                                {
                                    <MudExpansionPanel class="mb-2 editing"  Expanded=@(revision == project.Revisions.OrderBy(r => r.RevisionDate).Last())>
                                        <TitleContent>
                                            <div class="d-flex align-center">
                                                @if (revision.isCompleted)
                                                {

                                                    <span style="font-weight:bold">
                                                        <MudChip T="int" Variant="Variant.Outlined"
                                                        Color="Color.Success"
                                                        Size="Size.Medium">
                                                            Completed
                                                        </MudChip>
                                                    </span>
                                                }
                                                <span class="ml-2">Revision Date: @revision.RevisionDate.ToString("MM-dd-yyyy")</span>
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            @if(revision.isCompleted && isClient)
                                            {
                                                <MudHtmlViewer Html="@revision.Content" />
                                                <MudText Color=Color.Error Typo=Typo.caption>This revision is completed, you can't change it anymore, please add a new one if you want.</MudText>
                                            }
                                            else
                                            {

                                                <MudHtmlEditor style="margin-top:10px;" Html="@revision.Content" 
                                                OnFileUpload="@HandleFileUpload"  HtmlChanged="@(text => OnNoteTextChangedForRevision(revision,text))">
                                                </MudHtmlEditor>

                                                if(!isClient){
                                                    if (!revision.isCompleted)
                                                    {
                                                        <MudButton class="my-3" Color="Color.Info" Variant=Variant.Outlined OnClick="(() => MarkCompleted(revision))">Mark as completed!</MudButton>
                                                    }
                                                    else
                                                    {
                                                        <MudButton class="my-3" Variant=Variant.Outlined Color=Color.Warning OnClick="(() => MarkCompleted(revision))">Change to uncompleted!</MudButton>
                                                    }
                                                }
                                            }

                                        </ChildContent>
                                    </MudExpansionPanel>

                                }
                            </MudExpansionPanels>
                        }


                        <!-- Button to add a new revision -->
                        <MudButton Class="" Color="Color.Success" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Add" OnClick="AddRevision">Add New Revision</MudButton>

                    </MudText>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>

    <DialogActions>
        <MudItem sm="12">
            <MudSwitch @bind-Value="isViewMode" @onclick="ViewMode"
            Disabled="_isToggle"
            Color="Color.Info" UncheckedColor="Color.Default"
            ThumbIcon="@Icons.Material.Filled.Edit">
                @(isViewMode ? "View Mode" : "Edit Mode")
            </MudSwitch>
        </MudItem>
        <MudButton OnClick="@Cancel" Color="Color.Error" Variant="Variant.Outlined" Size="Size.Large" Disabled="Loading">Close</MudButton>
        <MudButton OnClick="@Save" Color="Color.Info" Variant="Variant.Outlined" Size="Size.Large" Disabled="Loading">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance Dialog { get; set; } = default!;
    [Parameter] public Project project { get; set; } = default!;
    [Parameter] public string currentRole { get; set; } = default!;
    [Parameter] public EventCallback<Project> modifiedProject { get; set; } = default!;
    [Parameter] public string currentUserId { get; set; } = default!;
    private string projectTitle = default!;
    bool isAdmin = false;
    bool isClient = false;
    bool isViewMode = true;
    bool _isToggle = false;
    bool Loading;
    private void ViewMode()
    {
        _isToggle = true;
        isViewMode = !isViewMode;
        StateHasChanged();
        _isToggle = false;
    }

    protected override async Task OnInitializedAsync()
    {
        isAdmin = currentRole == "Admin";
        isClient = currentRole == "Client";
        projectTitle = project.ProjectName;
        // fix for opening project-details from chat where revisions aren't included.
        if (project.Revisions == null)
        {
            await ReloadProject();
        }
        await base.OnInitializedAsync();
    }
    private async Task ReloadProject()
    {
        project = await projectServices.GetProjectByIdAsync(project.ProjectId) ?? project;

    }
    bool revisionAdded;
    private void AddRevision()
    {
        var newRevision = new Revision
            {
                RevisionDate = DateTime.UtcNow, 
                Content = string.Empty 
            };
        project.Revisions.Add(newRevision);
        revisionAdded = true;
    }
    private void OnNoteTextChanged(string text)
    {
        if (project != null)
        {
            project.Description = text;
        }
    }
    private void MarkCompleted(Revision revision)
    {
        revision.isCompleted = !revision.isCompleted;
    }
    private void OnNoteTextChangedForMusicPreference(string text)
    {
        if (project != null)
        {
            project.MusicPreference = text;
        }
    }
    private void OnNoteTextChangedForRevision(Revision revision,string text)
    {
        if (project != null)
        {
            revision.Content = text;
            var existingRevision = project.Revisions.FirstOrDefault(r => r.RevisionDate == revision.RevisionDate && r.RevisionId == revision.RevisionId);
            if (existingRevision != null)
                existingRevision.Content = text;
            else
            {
                project.Revisions.Add(revision);
            }
        }
    }
    private void OnDeliverableTextChanged(string text)
    {
        project.Deliverables = text;
    }
    private void OnMusicTextChanged(string text)
    {
        project.MusicPreference = text;
    }
    private async Task Save()
    {
        if (!isAdmin && projectTitle != project.ProjectName)
        {
            Snackbar.Add("You are not authorized to save changes.", Severity.Error);
            return;
        }
        await UpdateProjectAsync(project);
        if(revisionAdded) await ReloadProject(); // reload project if revision is added to avoid error when user saves new revision then modify it
        Snackbar.Add($"Successfully Saved.", Severity.Success);
    }
    [Inject] private ProjectService projectServices { get; set; } = default!;
    private async Task UpdateProjectAsync(Project project)
    {
        Loading = true;
        await projectServices.UpdateProjectAsync(project, currentUserId);
        Loading = false;
    }
    private void Cancel()
    {
        Dialog.Close(DialogResult.Cancel());
    }

    private async Task<string> HandleFileUpload(IBrowserFile file)
    {
        try
        {
            var url = await CloudflareService.UploadFileAsync(file);
            Console.WriteLine($"Upload successful, URL: {url}");
            return url;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Upload error in mudhtmleditor in page: {ex.Message}");
            throw;
        }
    }
}
<style>
    .mud-expand-panel.mud-panel-expanded.editing {
        margin:0px 0px 15px 0px !important;
    }
    .mud-expand-panel .mud-expand-panel-content
    {
        padding-bottom: 65px !important;
    }

    .equal-height > .mud-grid-item {
        display: flex;
        flex-direction: column;
    }

    .equal-height .mud-input {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .mud-input-control > .mud-input-control-input-container {
        height: 100%;
    }
</style>