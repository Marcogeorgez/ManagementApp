@using LuminaryVisuals.Data
@using LuminaryVisuals.Data.Entities
@using MudBlazor
@inject ISnackbar Snackbar
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudDialog>
    <DialogContent >
        <MudForm @ref="form" @bind-IsValid="@success" >
        <MudGrid Spacing="2" Justify="Justify.Center">
        <MudItem xs="12" sm="12">
            <MudText Typo=Typo.body1
                             Class="d-flex justify-center mud-width-full mb-2"> @newProject.ProjectName </MudText>
        </MudItem>
        <MudItem xs="12" sm="12">
            <MudNumericField T="decimal?" Required=true
                            @bind-Value="newProject.CalculationDetails.ClientDiscount"
                            Label="Client Discount"
                            Variant=Variant.Outlined
                            HelperTextOnFocus=true
                            AdornmentText="%"   
                            Adornment="Adornment.Start"
                            Class="d-flex justify-center mud-width-full" />
        </MudItem>
            @foreach (var (group, index) in groupedOptions.Select((g, i) => (g, i)))
            {
                <MudItem xs="12" sm="6">

                <MudSelect T="decimal?"
                           AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                           Class="d-flex justify-center mud-width-full"
                           Variant="Variant.Outlined"
                           @bind-Value="selectedMultipliers[index]"
                           Label="@GetParameterLabel(group.CalculationParameterId)">                
                        @foreach (var option in group.Options)
                        {
                            <MudSelectItem Class="" T="decimal?" Value="@option.Multiplier" Ripple=true>
                                @option.OptionName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                }
                <MudItem xs="12" sm="3">
                    <MudTextField T="string" Required=true
                          @bind-Value="newProject.CalculationDetails.CameraNumber"
                          Label="Number of Cameras"
                          Variant=Variant.Outlined
                          Class="d-flex justify-center mud-width-full" />
        </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField T="decimal?" Required=true
                          @bind-Value="newProject.CalculationDetails.FootageSize"
                          Label="Raw footage size"
                          Variant=Variant.Outlined
                          Adornment="Adornment.End"
                          AdornmentText="GB"
                          Class="d-flex justify-center mud-width-full"  />
        </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField T="decimal?" Required=true
                          @bind-Value="newProject.CalculationDetails.Misc"
                          Label="Misc (managmenet, footage handeling, feedback)"
                          Adornment="Adornment.End"
                          AdornmentText="hour"
                          Variant=Variant.Outlined
                          Class="d-flex flex-column  mud-width-full" />
        </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField T="string" Required=true
                        @bind-Value="newProject.CalculationDetails.PrePartsDuration"
                        Label="Pre parts Duration Minutes"
                        Variant=Variant.Outlined
                        Adornment="Adornment.End"
                        AdornmentText="min"
                        Class="d-flex flex-column  mud-width-full" />
        </MudItem>
                <MudItem xs="6" sm="3">
                    <MudTextField T="string" Required=true
                          @bind-Value="newProject.CalculationDetails.DocumentaryMulticameraDurationHours"
                          Label="Documentary Multicamera Duration"
                          Variant=Variant.Outlined
                          Adornment="Adornment.End"
                          AdornmentText="hour"
                          Class="d-flex flex-column  mud-width-full" />
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudTextField T="string" Required=true
                                  @bind-Value="newProject.CalculationDetails.DocumentaryMulticameraDuration"
                              Variant=Variant.Outlined
                              Adornment="Adornment.End"
                              AdornmentText="min"
                              Class="d-flex flex-column  mud-width-full py-2" />
        </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField T="string" Required=true
                              @bind-Value="newProject.CalculationDetails.HighlightsDuration"
                              Label="Highlights Duration Minutes"
                              Variant=Variant.Outlined
                              Adornment="Adornment.End"
                              AdornmentText="min"
                              Class="d-flex flex-column  mud-width-full" />
        </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField T="string" Required=true
                              @bind-Value="newProject.CalculationDetails.SocialMediaDuration"
                              Label="Social Media Duration Minutes"
                              Variant=Variant.Outlined
                              Adornment="Adornment.End"
                              AdornmentText="min"
                              AdornmentColor="Color.Default"
                              Class="d-flex flex-column  mud-width-full" />
        </MudItem>

                @if (_isAdminView)
                {
                    <MudItem xs="12">
                        <MudNumericField T="decimal?" Min="0.0M"
                                         @bind-Value="@newProject.CalculationDetails.FinalProjectBillableHours"
                                         Label="Total Hours"
                                         Variant=Variant.Filled Class="d-flex justify-center mud-width-full mt-3 mb-3" />
                    </MudItem>
                    <MudButton OnClick="CalculateBillableHours" FullWidth=false  Color="Color.Success" 
                        Variant=Variant.Outlined>Calculate Total </MudButton>
                }
        </MudGrid>

    </MudForm>
    </DialogContent>
    <DialogActions>
        <MudSpacer />
        @if(_isAdminView && newProject.SubmissionStatus == Models.SubmissionStatus.Approved)
        {
            <MudButton Class="d-flex flex-auto" Color="Color.Warning" Variant="Variant.Filled" Size="Size.Large" OnClick="@Unapprove">Unapprove</MudButton>

        }
        <MudButton Class="d-flex flex-auto" Color="Color.Error" Variant="Variant.Filled" Size="Size.Large" OnClick="@Cancel">Cancel</MudButton>
        <MudButton Class="d-flex flex-auto" Color="Color.Info" Variant="Variant.Filled" Size="Size.Large" OnClick="@Approve">@textRoleBased</MudButton>

    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public bool _isAdminView { get; set; } 
    [Parameter] public bool _isEditorView { get; set; }
    [Parameter] public Project newProject { get; set; } = new Project();
    private bool success;
    private bool _isOverriden;
    private MudForm form;
    private List<GroupedOptionsDto> groupedOptions = new List<GroupedOptionsDto>();
    private List<decimal?> selectedMultipliers;
    private int _cameraNum;
    private decimal footageSize;
    private decimal Misc;
    private decimal clientDiscount;
    private decimal _total;
    private Project _originalProject;
    private string textRoleBased;
    protected override async Task OnInitializedAsync()
    {
        using (var context = DbFactory.CreateDbContext())
        {
            groupedOptions = await context.CalculationOption
                .GroupBy(co => co.CalculationParameterId)
                .Select(group => new GroupedOptionsDto
                    {
                        CalculationParameterId = group.Key,
                        Options = group.Select(co => new OptionDto { OptionName = co.OptionName, Multiplier = co.Multiplier }).ToList()
                    })
                .ToListAsync();
            selectedMultipliers = new List<decimal?>
            {
            newProject.CalculationDetails?.HighlightsDifficulty
                ?? groupedOptions.FirstOrDefault(g => g.CalculationParameterId == 1)?.Options.FirstOrDefault()?.Multiplier,

            newProject.CalculationDetails?.PrePartsPrecentage
                ?? groupedOptions.FirstOrDefault(g => g.CalculationParameterId == 2)?.Options.FirstOrDefault()?.Multiplier,

            newProject.CalculationDetails?.Resolution
                ?? groupedOptions.FirstOrDefault(g => g.CalculationParameterId == 3)?.Options.FirstOrDefault()?.Multiplier,

            newProject.CalculationDetails?.FootageQuality
                ?? groupedOptions.FirstOrDefault(g => g.CalculationParameterId == 4)?.Options.FirstOrDefault()?.Multiplier
            };

            _originalProject = CloneProject(newProject);
            textRoleBased = _isAdminView == true ? "Approve" : "Submit For Review";
        }
    }


    private void CalculateBillableHours()
    {
        decimal? _cameraValue;
        newProject.CalculationDetails.HighlightsDifficulty = selectedMultipliers[0];
        newProject.CalculationDetails.PrePartsPrecentage = selectedMultipliers[1];
        newProject.CalculationDetails.Resolution = selectedMultipliers[2];
        newProject.CalculationDetails.FootageQuality = selectedMultipliers[3];
        decimal? _footageSize = newProject.CalculationDetails.FootageSize;
        decimal? _Misc = ( newProject.CalculationDetails.Misc * 60 ); // Calculate it in minutes
        decimal _prepartsDuration = 0;// Calculate it in minutes
        decimal _documentryMulticameraDuration = 0; // Calculate it in minutes
        decimal _hightlightDuration = 0; // Calculate it in minutes
        decimal _socialMediaDuration = 0; // Calculate it in minutes
        decimal? _clientDiscount = ( 1 - (newProject.CalculationDetails.ClientDiscount / 100) );

        _prepartsDuration += EvaluateExpression(newProject.CalculationDetails.PrePartsDuration) * 60;
        _documentryMulticameraDuration += EvaluateExpression(newProject.CalculationDetails.DocumentaryMulticameraDurationHours) * 60 + EvaluateExpression(newProject.CalculationDetails.DocumentaryMulticameraDuration);
        _hightlightDuration += EvaluateExpression(newProject.CalculationDetails.HighlightsDuration);
        _socialMediaDuration += EvaluateExpression(newProject.CalculationDetails.SocialMediaDuration);
        if (_cameraNum <= 2 && _cameraNum > 0)
            _cameraValue = 1;
        else
            _cameraValue = (_cameraNum - 2) * 0.03m + 1;

        // add as minutes
        if (_footageSize <= 300)
            _footageSize = 0;
        else
            _footageSize = (_footageSize - 300m) * 0.4m; // minutes

        // if <= 40 then * 8 if <= 90 then multiply the rest by 6, if > 90 multiply the rest with 4
        _documentryMulticameraDuration = _documentryMulticameraDuration <= 40
            ? _documentryMulticameraDuration * 8
            : _documentryMulticameraDuration <= 90
                ? ( 40 * 8 ) + ( ( _documentryMulticameraDuration - 40 ) * 6 )
                : ( 40 * 8 ) + ( 50 * 6 ) + ( ( _documentryMulticameraDuration - 90 ) * 4 );

        if(_hightlightDuration <= 3 )
        {
            _hightlightDuration = _hightlightDuration * 160;// mins
        }
        else if (_hightlightDuration <= 7)
        {
            _hightlightDuration = ( 3 * 160 ) + (_hightlightDuration - 3) * 110;// mins
        }
        else
        {
            _hightlightDuration = ( 3 * 160 ) + (4 * 110) + ( _hightlightDuration - 7 ) * 60;// mins
        }

        _hightlightDuration *= newProject.CalculationDetails.PrePartsPrecentage.Value * newProject.CalculationDetails.HighlightsDifficulty.Value;
        _socialMediaDuration *= 30;

        // Calculate the total duration of all components
        var totalDuration = _footageSize + _Misc + _prepartsDuration
                            + _documentryMulticameraDuration
                            + _hightlightDuration
                            + _socialMediaDuration;
        Console.WriteLine(totalDuration);
        // Calculate the quality multiplier
        var qualityMultiplier = newProject.CalculationDetails.FootageQuality!.Value * newProject.CalculationDetails.Resolution!.Value
                                * _cameraValue;

        // Combine the total duration with the quality multiplier and multiply the final by the discount
        var adjustedValue = (totalDuration * qualityMultiplier) * _clientDiscount;

        // Convert to hours and round to two decimal places
        newProject.CalculationDetails.FinalProjectBillableHours = Math.Round(adjustedValue.Value / 60, 2);

        StateHasChanged();
    }
    private decimal EvaluateExpression(string expression)
    {
        if (string.IsNullOrEmpty(expression))
        {
            return 0m; // Return 0 if expression is empty or null
        }

        try
        {
            var cleanedExpression = expression.Replace(" ", "");
            var expressionEvaluator = new NCalc.Expression(cleanedExpression);

            var result = expressionEvaluator.Evaluate();

            if (result is decimal decimalResult)
            {
                return decimalResult;
            }
            else if (result is int intResult)
            {
                return Convert.ToDecimal(intResult); // Convert int to decimal
            }
            else if (result is double doubleResult)
            {
                return Convert.ToDecimal(doubleResult); // Convert double to decimal
            }
            else
            {
                throw new InvalidOperationException("Invalid result type.");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("You need to enter numbers only!", Severity.Error);
            Console.WriteLine($"Error evaluating expression '{expression}': {ex.Message}");
            return 0m; // Return 0 if the evaluation fails
        }
    }
    private string GetParameterLabel(int parameterId)
    {
        return parameterId switch
        {
            1 => "Highlights Difficulty",
            2 => "Pre-Parts Percentage",
            3 => "Resolution",
            4 => "Footage Quality",
            _ => $"Group {parameterId}"
        };
    }

    public class GroupedOptionsDto
    {
        public int CalculationParameterId { get; set; }
        public List<OptionDto> Options { get; set; }
    }

    public class OptionDto
    {
        public string OptionName { get; set; }
        public decimal? Multiplier { get; set; }
    }

    private void Approve()
    {

        newProject.CalculationDetails.HighlightsDifficulty = selectedMultipliers[0];
        newProject.CalculationDetails.PrePartsPrecentage = selectedMultipliers[1];
        newProject.CalculationDetails.Resolution = selectedMultipliers[2];
        newProject.CalculationDetails.FootageQuality = selectedMultipliers[3];
        newProject.ClientBillableHours = newProject.CalculationDetails.FinalProjectBillableHours;
        if (_isAdminView)
        {
            newProject.SubmissionStatus = Models.SubmissionStatus.Approved;
        }
        if (_isEditorView && newProject.SubmissionStatus != Models.SubmissionStatus.Approved)
            newProject.SubmissionStatus = Models.SubmissionStatus.Submitted;

        MudDialog.Close(DialogResult.Ok(newProject));

    }
    private void Unapprove()
    {
        if (_isAdminView)
        {
            newProject.SubmissionStatus = Models.SubmissionStatus.Submitted;
        }
        MudDialog.Close(DialogResult.Ok(newProject));

    }

    private Project CloneProject(Project project)
    {
        return new Project
            {
                CalculationDetails = new Models.ProjectCalculationDetails
                {
                    HighlightsDifficulty = project.CalculationDetails?.HighlightsDifficulty,
                    PrePartsPrecentage = project.CalculationDetails?.PrePartsPrecentage,
                    Resolution = project.CalculationDetails?.Resolution,
                    FootageQuality = project.CalculationDetails?.FootageQuality,
                    CameraNumber = project.CalculationDetails?.CameraNumber,
                    FootageSize = project.CalculationDetails?.FootageSize,
                    Misc = project.CalculationDetails?.Misc,
                    PrePartsDuration = project.CalculationDetails?.PrePartsDuration,
                    DocumentaryMulticameraDuration = project.CalculationDetails?.DocumentaryMulticameraDuration,
                    DocumentaryMulticameraDurationHours = project.CalculationDetails?.DocumentaryMulticameraDurationHours,
                    HighlightsDuration = project.CalculationDetails?.HighlightsDuration,
                    SocialMediaDuration = project.CalculationDetails?.SocialMediaDuration,
                    FinalProjectBillableHours = project.CalculationDetails?.FinalProjectBillableHours
                },
                ClientBillableHours = project.ClientBillableHours
            };
    }
    private bool HasChanges()
    {
        bool isDifficultyDifferent = !Equals(_originalProject.CalculationDetails.HighlightsDifficulty, newProject.CalculationDetails.HighlightsDifficulty);
        bool isPrePartsPercentageDifferent = !Equals(_originalProject.CalculationDetails.PrePartsPrecentage, newProject.CalculationDetails.PrePartsPrecentage);
        bool isResolutionDifferent = !Equals(_originalProject.CalculationDetails.Resolution, newProject.CalculationDetails.Resolution);
        bool isFootageQualityDifferent = !Equals(_originalProject.CalculationDetails.FootageQuality, newProject.CalculationDetails.FootageQuality);
        bool isCameraNumberDifferent = !Equals(_originalProject.CalculationDetails.CameraNumber, newProject.CalculationDetails.CameraNumber);
        bool isFootageSizeDifferent = !Equals(_originalProject.CalculationDetails.FootageSize, newProject.CalculationDetails.FootageSize);
        bool isMiscDifferent = !Equals(_originalProject.CalculationDetails.Misc, newProject.CalculationDetails.Misc);
        bool isPrePartsDurationDifferent = !Equals(_originalProject.CalculationDetails.PrePartsDuration, newProject.CalculationDetails.PrePartsDuration);
        bool isDocMulticameraDurationDifferent = !Equals(_originalProject.CalculationDetails.DocumentaryMulticameraDuration, newProject.CalculationDetails.DocumentaryMulticameraDuration);
        bool isDocMulticameraDurationHoursDifferent = !Equals(_originalProject.CalculationDetails.DocumentaryMulticameraDurationHours, newProject.CalculationDetails.DocumentaryMulticameraDurationHours);
        bool isHighlightsDurationDifferent = !Equals(_originalProject.CalculationDetails.HighlightsDuration, newProject.CalculationDetails.HighlightsDuration);
        bool isSocialMediaDurationDifferent = !Equals(_originalProject.CalculationDetails.SocialMediaDuration, newProject.CalculationDetails.SocialMediaDuration);
        bool isFinalBillableHoursDifferent = !Equals(_originalProject.CalculationDetails.FinalProjectBillableHours, newProject.CalculationDetails.FinalProjectBillableHours);
        bool isClientBillableHoursDifferent = !Equals(_originalProject.ClientBillableHours, newProject.ClientBillableHours);

        return isDifficultyDifferent || isPrePartsPercentageDifferent || isResolutionDifferent ||
               isFootageQualityDifferent || isCameraNumberDifferent || isFootageSizeDifferent ||
               isMiscDifferent || isPrePartsDurationDifferent || isDocMulticameraDurationDifferent ||
               isDocMulticameraDurationHoursDifferent || isHighlightsDurationDifferent ||
               isSocialMediaDurationDifferent || isFinalBillableHoursDifferent ||
               isClientBillableHoursDifferent;

    }
    [Inject] private IDialogService DialogService { get; set; }
    private async Task Cancel()
    {
        if (HasChanges() == true)
        {
            bool? resultte = await DialogService.ShowMessageBox("Unsaved Changes", "You have unsaved changes. Are you sure you want to close?",
                   yesText: "Discard", cancelText: "Cancel");
            if (resultte == true)
            {
                MudDialog.Cancel();
            }

        }

        else
        {
            MudDialog.Cancel();
        }
    }
}