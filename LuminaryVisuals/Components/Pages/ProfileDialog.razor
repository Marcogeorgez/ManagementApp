@using LuminaryVisuals.Components.Shared.ProfileComponents
@using Microsoft.AspNetCore.Authorization
@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> _userManager;
@inject IDialogService DialogService
<MudContainer>
<MudDialog>
    <DialogContent>

        <MudText Typo="Typo.h3" Class="mt-2">Hello, @userName</MudText>
                        <MudForm @ref="form" @bind-IsValid="@success">
                <MudItem xs="12" Class="mt-8 pl-5">
                    <MudText Typo="Typo.h5">Profile Settings</MudText>
                                        </MudItem>
        <MudGrid Class="d-flex flex-row px-10 my-1" Justify="Justify.Center" Spacing="6">
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="Current Username" @bind-Value="@userName"
                        ReadOnly="true" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="New Username" @bind-Value="model.NewUsername"
                        Required="true" RequiredError="New username is required!" 
                        Validation="@(new Func<string, IEnumerable<string>>(ValidateUsername))"
                            Variant="Variant.Outlined"  />
                </MudItem>
        </MudGrid>
        <MudButton Variant="Variant.Filled" Color="Color.Info" Class="ml-auto mt-5 mr-9" 
                Disabled="@(!success || processing)" OnClick="ChangeUsernameAsync">
                @if (processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Update Username</MudText>
                }
        </MudButton>
        </MudForm>

        <MudGrid Class="px-10 my-3 d-flex flex-auto align-center" Justify="Justify.Center" Spacing="6">
            <MudItem xs="6">
            <MudText Typo="Typo.h5" Class="pl-5">Revoke Login From All Devices</MudText>
                </MudItem>
                <MudItem xs="6">

                    <MudButton OnClick="RevokeLogin" Color="Color.Error" Variant="Variant.Filled"
                    Class="ml-auto px-10 d-flex">Revoke</MudButton>
                    </MudItem>

        </MudGrid>
        @if (userRole == "Client")
        {
            <MudText Class="mt-2">Please fill the following form to know more about your preferences</MudText>
            <MudButton Class="mt-3 mb-4 ml-3 mr-3" Color=Color.Info  
            StartIcon="@Icons.Material.Filled.EditNote" Variant="Variant.Filled" 
            OnClick="buttonCLicked"> Projects Preferences </MudButton>
            if(isClicked)
            {
                <ClientEditingGuidelinesComponent userId="@userId"/>
            }
        }
        <form id="logoutForm" action="Account/Logout" method="post" style="display:none;">
            <AntiforgeryToken />
            <input type="hidden" name="ReturnUrl" value="" />
        </form>
    </DialogContent>

    <DialogActions>
                        <MudItem xs="12" Class="mt-8 px-11">

        <div class="d-flex mb-5 flex-auto" style="max-width:100%;">
        <MudButton StartIcon="@Icons.Material.Filled.ExitToApp" IconColor="Color.Tertiary" 
        Class="ml-5  px-14" OnClick="@LogoutClick" Color="Color.Default" Variant="Variant.Filled" 
        Size="Size.Medium">Log out</MudButton>
        <MudSpacer/>
        <MudButton Class="mr-5 px-14" OnClick="@Cancel" Color="Color.Error" Variant="Variant.Filled" Size="Size.Medium">Close</MudButton>
        </div>
        </MudItem>
    </DialogActions>

</MudDialog>

</MudContainer>
@code
{
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public ClaimsPrincipal? currentUser { get; set; }
    private ApplicationUser? user;
    private string userRole;
    private string userId;
    private bool isChangeInfo;
    private bool isClicked;
    string? userName;
    private MudForm form;
    private bool success;
    private bool processing;
    private UsernameChangeModel model = new();
    private void buttonCLicked()
    {
        isClicked = !isClicked;
    }
    private void isChangingInfo()
    {
        isChangeInfo = !isChangeInfo;
    }
    protected override async Task OnInitializedAsync()
    {
        try
        {
            user = await UserManager.GetUserAsync(currentUser!);
            userName = user?.UserName;
            userRole = currentUser!.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value!;
            userId = currentUser.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value!;
        }
        catch(Exception ex)
        {
            throw ex;
        }
    }


    private IEnumerable<string> ValidateUsername(string username)
    {
        if (string.IsNullOrWhiteSpace(username))
            yield return "Username is required!";
        if (username?.Length < 3)
            yield return "Username must be at least 3 characters!";
        if (username?.Length > 100)
            yield return "Username must not exceed 100 characters!";
        if (!System.Text.RegularExpressions.Regex.IsMatch(username ?? "", @"^[a-zA-Z _]*$"))
            yield return "Username can only contain letters, spaces, and underscores!";
    }

    private async Task ChangeUsernameAsync()
    {
        await form.Validate();

        if (form.IsValid)
        {
            var parameters = new DialogParameters
            {
                { "Message", $"Are you sure you want to change your name? This will result in you logging-out." }
            };

            var dialog = DialogService.Show<ConfirmationDialog>("Confirmation", parameters);
            var dialogResult = await dialog.Result;
            if (!dialogResult.Canceled)
            {
                processing = true;
                var user = await UserManager.GetUserAsync(currentUser);

                if (user != null)
                {
                    // Check if new username is already taken
                    var userWithNewUsername = await UserManager.FindByNameAsync(model.NewUsername);
                    if (userWithNewUsername != null && userWithNewUsername.Id != user.Id)
                    {
                        Snackbar.Add("Username is already taken!", Severity.Error);
                        processing = false;
                        return;
                    }

                    // Update username
                    var result = await UserManager.SetUserNameAsync(user, model.NewUsername);

                    if (result.Succeeded)
                    {
                        userName = model.NewUsername;
                        // Update normalized username
                        await UserManager.UpdateNormalizedUserNameAsync(user);
                        Snackbar.Add("Username updated successfully!", Severity.Success);
                    }

                    else
                    {
                        foreach (var error in result.Errors)
                        {
                            Snackbar.Add(error.Description, Severity.Error);
                        }
                    }
                    processing = false;

                }
                else
                {
                    return;
                }
            }

        }
    }

    public class UsernameChangeModel
    {
        public string NewUsername { get; set; }
    }

    private void Cancel()
    {
        MudDialog.Cancel(); // Close without saving
    }

    private void RevokeLogin()
    {
        _userManager.UpdateSecurityStampAsync(user);
    }

    private async Task LogoutClick()
    {
        await JSRuntime.InvokeVoidAsync("submitForm", "logoutForm");
    }
}