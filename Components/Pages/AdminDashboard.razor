@page "/admin-dashboard"
@using LuminaryVisuals.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@* @attribute [Authorize(Roles = "Admin")] *@
@inject UserManagementService UserManagementService
@inject HttpClient httpClient
@inject RoleManager<IdentityRole> RoleManager

@inject ILogger<AdminDashboard> Logger
@inject IDialogService DialogService


<PageTitle>Admin Dashboard</PageTitle>

@if (_loading)
{
    <MudText Typo="Typo.h5">Admin Dashboard</MudText>
    <MudSpacer />
    <LoadingComponent />
}
else if (_error)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" >
        An error occurred while loading users.
    </MudAlert>
}
else
{
    @if (!string.IsNullOrEmpty(_updateMessage))
    {
        <MudAlert Severity="@(_updateMessageClass == "alert-success" ? Severity.Success : Severity.Error)"
                  Variant="Variant.Filled"
                  ShowCloseIcon="true"
                  CloseIconClicked="@(() => {_updateMessage = null;})"
                  OnClick="@(() => { _updateMessage = null; })">
            @_updateMessage
        </MudAlert>
    }


    <MudDataGrid T="UserRoleViewModel" MultiSelection="true" Items="@AllUsers" SortMode="SortMode.Multiple"
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" Filterable="true"
                 ColumnResizeMode="ResizeMode.Column" DragIndicatorSize="Size.Small">
        <ToolBarContent>
            <MudText Typo="Typo.h5">Admin Dashboard</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Placeholder="Search by name" Adornment="Adornment.Start"
                          Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                          Class="mt-0"></MudTextField>
        </ToolBarContent>
        <Columns>
            <SelectColumn T="UserRoleViewModel" />
            <TemplateColumn T="UserRoleViewModel" Title="#" Sortable="false" Filterable="false">
                <CellTemplate Context="cell">
                    @{
                        var index = AllUsers.ToList().IndexOf(cell.Item) + 1;
                        @index
                    }
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Style="max-width: 150px" Property="x => x.UserName" Title="User Name">
                <CellTemplate>
                    @context.Item.UserName
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => GetRolesAsString(x)" Title="Current Role" />

            <TemplateColumn Title="Change Role" Style="max-width: 150px; overflow-x: hidden;">
                <CellTemplate>
                    <MudMenu Label="@(context.Item.Roles?.FirstOrDefault() ?? "Select New Role")"
                             Variant="Variant.Outlined"
                             Color="Color.Secondary"
                             Dense="true"
                             Disabled="@(_isUpdating && _updatingUserId == context.Item.UserId)">
                        <MudMenuItem OnClick="@(() => UpdateSelectedRole(context.Item, "Admin"))">Admin</MudMenuItem>
                        <MudMenuItem OnClick="@(() => UpdateSelectedRole(context.Item, "Editor"))">Editor</MudMenuItem>
                        <MudMenuItem OnClick="@(() => UpdateSelectedRole(context.Item, "Client"))">Client</MudMenuItem>
                        <MudMenuItem OnClick="@(() => UpdateSelectedRole(context.Item, "Guest"))">Guest</MudMenuItem>
                    </MudMenu>
                    @if (_isUpdating && _updatingUserId == context.Item.UserId)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ms-3" />
                    }
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="UserRoleViewModel" />
        </PagerContent>
    </MudDataGrid>
}

@code {
    private bool _loading = true;
    private bool _error = false;
    private string _updateMessage;
    private string _updateMessageClass;
    private bool _isUpdating;
    private string _updatingUserId;
    private string _searchString;
    private bool _sortNameByLength;
    private List<string> _availableRoles = new();
    private List<UserRoleViewModel> _users;
    private IEnumerable<UserRoleViewModel> AllUsers = new List<UserRoleViewModel>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _availableRoles = await GetAvailableRoles();
            AllUsers = await UserManagementService.GetAllUsersWithRolesAsync();
            _users = AllUsers.ToList();
            _loading = false;


        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading users");
            _error = true;
            _loading = false;
        }
    }

    private async Task<List<string>> GetAvailableRoles()
    {
        var roles = await RoleManager.Roles.Select(r => r.Name).ToListAsync();
        return roles.Where(r => r != null).ToList();
    }

    private string GetRolesAsString(UserRoleViewModel user)
    {
        return string.Join(", ", user.Roles ?? new List<string>());
    }

    private async Task UpdateSelectedRole(UserRoleViewModel user, string newRole)
    {
        try
        {
            if (string.IsNullOrEmpty(newRole))
            {
                return;
            }
            if (newRole == "Admin")
            {
                var parameters = new DialogParameters
                {
                    { "Message" , $"Are you sure you want to change {user.UserName} role to Admin?"}
                };
                var dialog = DialogService.Show<ConfirmationDialog>("Confirmation", parameters);
                var toProceed = await dialog.Result;

                if (!toProceed.Canceled && !(bool)toProceed.Data)
                {
                    return;
                }
            }
            _isUpdating = true;
            _updatingUserId = user.UserId;
            var result = await UserManagementService.ChangeUserRoleAsync(user.UserId, newRole);

            if (result)
            {
                var updatedUser = _users.First(u => u.UserId == user.UserId);
                updatedUser.Roles = new List<string> { newRole };
                _updateMessage = $"Successfully updated role for {user.UserName} to {newRole}";
                _updateMessageClass = "alert-success";
                Logger.LogInformation($"Successfully updated role for user {user.UserName} to {newRole}");

                var elementUser = AllUsers.First(u => u.UserId == user.UserId);
                elementUser.Roles = new List<string> { newRole };
            }
            else
            {
                _updateMessage = $"Failed to update role for {user.UserName}";
                _updateMessageClass = "alert-danger";
                Logger.LogError($"Failed to update role for user {user.UserName}");
            }
        }
        catch (Exception ex)
        {
            _updateMessage = $"Error updating role: {ex.Message}";
            _updateMessageClass = "alert-danger";
            Logger.LogError(ex, "Error changing user role");
        }
        finally
        {
            _isUpdating = false;
            _updatingUserId = null;
            StateHasChanged();
        }
    }
}